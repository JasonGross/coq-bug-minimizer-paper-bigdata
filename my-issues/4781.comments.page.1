[{"url":"https://api.github.com/repos/coq/coq/issues/comments/337543058","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-337543058","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":337543058,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU0MzA1OA==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2016-06-04T16:50:46Z","updated_at":"2018-01-25T22:44:04Z","author_association":"CONTRIBUTOR","body":"Comment author: @JasonGross\r\n\r\nConsider this typeclass:\r\n```coq\r\n\r\nLtac force_clear :=\r\n  clear;\r\n  repeat match goal with\r\n         | [ H : _ |- _ ] => clear H\r\n         | [ H := _ |- _ ] => clearbody H\r\n         end.\r\n\r\nClass abstract_term {T} (x : T) := by_abstract_term : T.\r\nHint Extern 0 (@ abstract_term ?T ?x) => force_clear; change T; abstract (exact x) : typeclass_instances.\r\n\r\nGoal True.\r\n(* These work: *)\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  pose x.\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := (eval cbv iota in (let v : T := x in v)) in\r\n  pose x.\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := match constr:(Set) with ?y => constr:(y) end in\r\n  pose x.\r\n(* This fails with an error: *)\r\n  Fail let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := match constr:(x) with ?y => constr:(y) end in\r\n  pose x. (* The command has indeed failed with message:\r\nError: Variable y should be bound to a term. *)\r\n(* And the rest fail with Anomaly: Uncaught exception Not_found. Please report. *)\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := match constr:(x) with ?y => y end in\r\n  pose x.\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := (eval cbv iota in x) in\r\n  pose x.\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := type of x in\r\n  pose x.\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:(_ : abstract_term term) in\r\n  let x := type of x in\r\n  pose x.\r\n```\r\n\r\nApparently what [cbv iota] doesn't see can't hurt it, and [pose] is perfectly happy with abstracted lemmas only some of the time.\r\n\r\nEven stranger, consider:\r\n```coq\r\n\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let y := (eval cbv iota in (let v : T := x in v)) in\r\n  pose y;\r\n    let x' := fresh \"x'\" in\r\n    pose x as x'.\r\n      let x := (eval cbv delta [x'] in x') in\r\n      pose x;\r\n      let z := (eval cbv iota in x) in\r\n      pose z.\r\n\r\n```\r\nThis works fine.  But if I change the period to a semicolon, I get:\r\n```coq\r\n\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let y := (eval cbv iota in (let v : T := x in v)) in\r\n  pose y;\r\n    let x' := fresh \"x'\" in\r\n    pose x as x';\r\n      let x := (eval cbv delta [x'] in x') in\r\n      pose x. (* Anomaly: Uncaught exception Not_found. Please report. *)\r\n\r\n```\r\nand if I use the second one instead of [pose x] (note that using [idtac] works fine), I get:\r\n```coq\r\n\r\n  let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let y := (eval cbv iota in (let v : T := x in v)) in\r\n  pose y;\r\n    let x' := fresh \"x'\" in\r\n    pose x as x';\r\n      let x := (eval cbv delta [x'] in x') in\r\n      let z := (eval cbv iota in x) in (* Error: Variable x should be bound to a term. *)\r\n      idtac.\r\n```\r\n\r\n\r\nSo, uh, it looks like something is forgetting to update the global environment, or is threading the state through in different ways that aren't coordinating, perhaps?\r\n\r\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337543058/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337543059","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-337543059","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":337543059,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU0MzA1OQ==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2016-09-29T15:42:50Z","updated_at":"2018-01-25T22:44:22Z","author_association":"CONTRIBUTOR","body":"Comment author: @gares\r\n\r\nThis bug could be related to #4863\r\nTo be tested after the bugfix Matthieu is implementing.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337543059/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337543061","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-337543061","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":337543061,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU0MzA2MQ==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-06-08T12:38:47Z","updated_at":"2017-10-18T10:27:43Z","author_association":"CONTRIBUTOR","body":"Comment author: @Zimmi48\n\nThe anomalies are indeed fixed in 8.6.\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337543061/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/360622374","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-360622374","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":360622374,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDYyMjM3NA==","user":{"login":"tchajed","id":1255037,"node_id":"MDQ6VXNlcjEyNTUwMzc=","avatar_url":"https://avatars.githubusercontent.com/u/1255037?v=4","gravatar_id":"","url":"https://api.github.com/users/tchajed","html_url":"https://github.com/tchajed","followers_url":"https://api.github.com/users/tchajed/followers","following_url":"https://api.github.com/users/tchajed/following{/other_user}","gists_url":"https://api.github.com/users/tchajed/gists{/gist_id}","starred_url":"https://api.github.com/users/tchajed/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tchajed/subscriptions","organizations_url":"https://api.github.com/users/tchajed/orgs","repos_url":"https://api.github.com/users/tchajed/repos","events_url":"https://api.github.com/users/tchajed/events{/privacy}","received_events_url":"https://api.github.com/users/tchajed/received_events","type":"User","site_admin":false},"created_at":"2018-01-25T22:29:51Z","updated_at":"2018-01-25T22:29:51Z","author_association":"CONTRIBUTOR","body":"This bug has (at least partially) regressed between v8.6 and v8.7.1 as of d0e05a1964f.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/360622374/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/360625961","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-360625961","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":360625961,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDYyNTk2MQ==","user":{"login":"SkySkimmer","id":2461932,"node_id":"MDQ6VXNlcjI0NjE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/2461932?v=4","gravatar_id":"","url":"https://api.github.com/users/SkySkimmer","html_url":"https://github.com/SkySkimmer","followers_url":"https://api.github.com/users/SkySkimmer/followers","following_url":"https://api.github.com/users/SkySkimmer/following{/other_user}","gists_url":"https://api.github.com/users/SkySkimmer/gists{/gist_id}","starred_url":"https://api.github.com/users/SkySkimmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SkySkimmer/subscriptions","organizations_url":"https://api.github.com/users/SkySkimmer/orgs","repos_url":"https://api.github.com/users/SkySkimmer/repos","events_url":"https://api.github.com/users/SkySkimmer/events{/privacy}","received_events_url":"https://api.github.com/users/SkySkimmer/received_events","type":"User","site_admin":false},"created_at":"2018-01-25T22:45:12Z","updated_at":"2018-01-25T22:45:12Z","author_association":"CONTRIBUTOR","body":"That commit is in 8.8, not 8.7 though.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/360625961/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/360626780","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-360626780","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":360626780,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDYyNjc4MA==","user":{"login":"tchajed","id":1255037,"node_id":"MDQ6VXNlcjEyNTUwMzc=","avatar_url":"https://avatars.githubusercontent.com/u/1255037?v=4","gravatar_id":"","url":"https://api.github.com/users/tchajed","html_url":"https://github.com/tchajed","followers_url":"https://api.github.com/users/tchajed/followers","following_url":"https://api.github.com/users/tchajed/following{/other_user}","gists_url":"https://api.github.com/users/tchajed/gists{/gist_id}","starred_url":"https://api.github.com/users/tchajed/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tchajed/subscriptions","organizations_url":"https://api.github.com/users/tchajed/orgs","repos_url":"https://api.github.com/users/tchajed/repos","events_url":"https://api.github.com/users/tchajed/events{/privacy}","received_events_url":"https://api.github.com/users/tchajed/received_events","type":"User","site_admin":false},"created_at":"2018-01-25T22:48:52Z","updated_at":"2018-01-25T22:48:52Z","author_association":"CONTRIBUTOR","body":"Fair enough - I'll bisect to more precisely say where the regression is soon.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/360626780/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/360627366","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-360627366","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":360627366,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDYyNzM2Ng==","user":{"login":"SkySkimmer","id":2461932,"node_id":"MDQ6VXNlcjI0NjE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/2461932?v=4","gravatar_id":"","url":"https://api.github.com/users/SkySkimmer","html_url":"https://github.com/SkySkimmer","followers_url":"https://api.github.com/users/SkySkimmer/followers","following_url":"https://api.github.com/users/SkySkimmer/following{/other_user}","gists_url":"https://api.github.com/users/SkySkimmer/gists{/gist_id}","starred_url":"https://api.github.com/users/SkySkimmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SkySkimmer/subscriptions","organizations_url":"https://api.github.com/users/SkySkimmer/orgs","repos_url":"https://api.github.com/users/SkySkimmer/repos","events_url":"https://api.github.com/users/SkySkimmer/events{/privacy}","received_events_url":"https://api.github.com/users/SkySkimmer/received_events","type":"User","site_admin":false},"created_at":"2018-01-25T22:51:34Z","updated_at":"2018-01-25T22:51:34Z","author_association":"CONTRIBUTOR","body":"Was it actually fixed? We have `test-suite/bugs/opened/4781.v` since 633ed9c52.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/360627366/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/360629130","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-360629130","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":360629130,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDYyOTEzMA==","user":{"login":"tchajed","id":1255037,"node_id":"MDQ6VXNlcjEyNTUwMzc=","avatar_url":"https://avatars.githubusercontent.com/u/1255037?v=4","gravatar_id":"","url":"https://api.github.com/users/tchajed","html_url":"https://github.com/tchajed","followers_url":"https://api.github.com/users/tchajed/followers","following_url":"https://api.github.com/users/tchajed/following{/other_user}","gists_url":"https://api.github.com/users/tchajed/gists{/gist_id}","starred_url":"https://api.github.com/users/tchajed/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tchajed/subscriptions","organizations_url":"https://api.github.com/users/tchajed/orgs","repos_url":"https://api.github.com/users/tchajed/repos","events_url":"https://api.github.com/users/tchajed/events{/privacy}","received_events_url":"https://api.github.com/users/tchajed/received_events","type":"User","site_admin":false},"created_at":"2018-01-25T22:59:40Z","updated_at":"2018-01-25T22:59:40Z","author_association":"CONTRIBUTOR","body":"Nope, looks like the bug is in v8.6.1 and v8.7.1 as well, so it seems unlikely it was ever fixed?","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/360629130/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/360630107","html_url":"https://github.com/coq/coq/issues/4781#issuecomment-360630107","issue_url":"https://api.github.com/repos/coq/coq/issues/4781","id":360630107,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDYzMDEwNw==","user":{"login":"SkySkimmer","id":2461932,"node_id":"MDQ6VXNlcjI0NjE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/2461932?v=4","gravatar_id":"","url":"https://api.github.com/users/SkySkimmer","html_url":"https://github.com/SkySkimmer","followers_url":"https://api.github.com/users/SkySkimmer/followers","following_url":"https://api.github.com/users/SkySkimmer/following{/other_user}","gists_url":"https://api.github.com/users/SkySkimmer/gists{/gist_id}","starred_url":"https://api.github.com/users/SkySkimmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SkySkimmer/subscriptions","organizations_url":"https://api.github.com/users/SkySkimmer/orgs","repos_url":"https://api.github.com/users/SkySkimmer/repos","events_url":"https://api.github.com/users/SkySkimmer/events{/privacy}","received_events_url":"https://api.github.com/users/SkySkimmer/received_events","type":"User","site_admin":false},"created_at":"2018-01-25T23:03:56Z","updated_at":"2018-01-25T23:03:56Z","author_association":"CONTRIBUTOR","body":"It seems the following 2 still get uncaught `Not_found` but the rest succeed or fail with catchable errors\r\n```coq\r\n  Fail let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:((_ : abstract_term term) : T) in\r\n  let x := type of x in\r\n  pose x. (* should succeed *)\r\n  Fail let term := constr:(I) in\r\n  let T := type of term in\r\n  let x := constr:(_ : abstract_term term) in\r\n  let x := type of x in\r\n  pose x. (* should succeed *)\r\n```","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/360630107/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]