[{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555994","html_url":"https://github.com/coq/coq/issues/5662#issuecomment-337555994","issue_url":"https://api.github.com/repos/coq/coq/issues/5662","id":337555994,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU1NTk5NA==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-07-21T19:16:13Z","updated_at":"2018-12-05T20:01:49Z","author_association":"CONTRIBUTOR","body":"Comment author: @JasonGross\r\n\r\nI'd like to see a version of [vm_compute] that also reduces type arguments.  \r\nFor example, in:\r\n```coq\r\nRecord HOLD T := hold { v : T }.\r\nUnset Printing Records.\r\nDefinition nat' := nat.\r\nGoal True.\r\n  let v := constr:(@ hold nat' 5) in\r\n  let v' := (eval vm_compute in v) in\r\n  pose v'.\r\n```\r\nI want to see [hold nat 5 : HOLD nat], not [hold nat' 5 : HOLD nat'].  When \r\n[nat'] is a massive term and [nat] is small, this can cause massive slowdowns \r\n(10x or more) in printing, computing, evar-normalization, etc.  I lost about 10 \r\nhours of debugging time to tracking down this performance bottleneck.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555994/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555995","html_url":"https://github.com/coq/coq/issues/5662#issuecomment-337555995","issue_url":"https://api.github.com/repos/coq/coq/issues/5662","id":337555995,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU1NTk5NQ==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-07-21T19:23:45Z","updated_at":"2017-10-18T11:09:15Z","author_association":"CONTRIBUTOR","body":"Comment author: @JasonGross\n\nFor the historical record, the way that I noticed something was wrong was that \n[let k := (eval vm_compute in (lem x)) in pose k as K] led to subsequent \ncommands (such as [let v := constr:(K) in idtac]) to have massively different \nperformance than they did when I did [let x' := (eval vm_compute in x) in let k \n:= (eval vm_compute in (lem x')) in pose k as K].  It took me only a little \nwhile to figure out that (and where) the vm wasn't fully normalizing its \narguments.\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555995/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555997","html_url":"https://github.com/coq/coq/issues/5662#issuecomment-337555997","issue_url":"https://api.github.com/repos/coq/coq/issues/5662","id":337555997,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU1NTk5Nw==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-07-30T22:57:31Z","updated_at":"2017-10-18T11:09:15Z","author_association":"CONTRIBUTOR","body":"Comment author: @ppedrot\n\nIt doesn't make sense. The 'eval _ in _' command works at the term level, and doesn't really care about types. In particular, it return terms and there is no way to make them also carry their type without changing everything in the Ltac implementation.\n\nI'd therefore recommend closing with bug with a WONTFIX, but you may be unhappy about it...\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555997/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555998","html_url":"https://github.com/coq/coq/issues/5662#issuecomment-337555998","issue_url":"https://api.github.com/repos/coq/coq/issues/5662","id":337555998,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU1NTk5OA==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-07-31T00:34:35Z","updated_at":"2017-10-18T11:09:15Z","author_association":"CONTRIBUTOR","body":"Comment author: @JasonGross\n\nWhat?  No, this is about reducing indices(?) of inductive constructors, which shows up as a difference in types. Perhaps I misnamed the bug title.  This is a request to make a variant of [eval vm_compute in] that returns the same term as [eval compute in] (assuming no opacity).\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337555998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337556000","html_url":"https://github.com/coq/coq/issues/5662#issuecomment-337556000","issue_url":"https://api.github.com/repos/coq/coq/issues/5662","id":337556000,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU1NjAwMA==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-07-31T00:53:42Z","updated_at":"2017-10-18T11:09:16Z","author_association":"CONTRIBUTOR","body":"Comment author: @ppedrot\n\nAh, sorry, I misunderstood your report. It looks to me that this is due to the way we decompile VM objects, and in particular because we don't use the right type. Otherwise I don't understand why vm_compute would behave differently than eval vm_compute in. And in that case, there is still an issue linked to the lack of a proper value type which is impossible to work around. That said, I'll have a closer look at this.\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337556000/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337556001","html_url":"https://github.com/coq/coq/issues/5662#issuecomment-337556001","issue_url":"https://api.github.com/repos/coq/coq/issues/5662","id":337556001,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzU1NjAwMQ==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2017-07-31T01:10:38Z","updated_at":"2017-10-18T11:09:16Z","author_association":"CONTRIBUTOR","body":"Comment author: @ppedrot\n\nOK, so I think the problem can be summarized as follows:\n\nFirst, VM normalization relies on the type of the expression to decompile the VM value into a Coq term.\n\nIn particular, contrarily to the kernel representation, parameters are not arguments of the VM representation of constructors. Indeed, they are not needed, as they can be infered from the type of the expression.\n\nSo your problem is the following: you take an applied constructor [c params args], known to live in type [I params indices]. You reduce it through the VM and get an abstract value. Then you reify the value in type [I params indices]. Alas, the type used for inference is not the one you'd be expecting, leading to the inference of parameters that you observe for the reified value.\n\nUnluckily, I don't think there is an easy way around. For instance, vm-normalizing the type beforehand looks like a no-no to me for efficiency reasons, and likewise, it doesn't seem reasonable to modify the VM representation.\n\nYou can probably emulate the first solution Ltac-side, though.\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337556001/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]