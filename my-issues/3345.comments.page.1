[{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519733","html_url":"https://github.com/coq/coq/issues/3345#issuecomment-337519733","issue_url":"https://api.github.com/repos/coq/coq/issues/3345","id":337519733,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzUxOTczMw==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2014-05-25T09:05:06Z","updated_at":"2021-08-07T10:12:38Z","author_association":"CONTRIBUTOR","body":"Comment author: @JasonGross\r\n```coq\r\n(* File reduced by coq-bug-finder from original input, then from 1972 lines to 136 lines, then from 119 lines to 105 lines *)\r\nGlobal Set Implicit Arguments.\r\nRequire Import Coq.Lists.List Program.\r\nSection IndexBound.\r\n  Context {A : Set}.\r\n  Class IndexBound (a : A) (Bound : list A) :=\r\n    { ibound :> nat;\r\n      boundi : nth_error Bound ibound = Some a}.\r\n  Global Arguments ibound [a Bound] _ .\r\n  Global Arguments boundi [a Bound] _.\r\n  Record BoundedIndex (Bound : list A) := { bindex :> A; indexb :> IndexBound bindex Bound }.\r\nEnd IndexBound.\r\nContext {A : Type} {C : Set}.\r\nVariable (projAC : A -> C).\r\nLemma None_neq_Some\r\n: forall (AnyT AnyT' : Type) (a : AnyT),\r\n    None = Some a -> AnyT'.\r\n  admit.\r\nDefined.\r\nProgram Definition nth_Bounded'\r\n           (Bound : list A)\r\n           (c : C)\r\n           (a_opt : option A)\r\n           (nth_n : option_map projAC a_opt = Some c)\r\n: A := match a_opt as x\r\n             return (option_map projAC x = Some c) -> A with\r\n         | Some a => fun _ => a\r\n         | None => fun f : None = Some _ => !\r\n       end nth_n.\r\nLemma nth_error_map :\r\n  forall n As c_opt,\r\n    nth_error (map projAC As) n = c_opt\r\n    -> option_map projAC (nth_error As n) = c_opt.\r\n  admit.\r\nDefined.\r\nDefinition nth_Bounded\r\n           (Bound : list A)\r\n           (idx : BoundedIndex (map projAC Bound))\r\n: A := nth_Bounded' Bound (nth_error Bound (ibound idx))\r\n                    (nth_error_map _ _ (boundi idx)).\r\nProgram Definition nth_Bounded_ind2\r\n        (P : forall As, BoundedIndex (map projAC As)\r\n                        -> BoundedIndex (map projAC As)\r\n                        -> A -> A -> Prop)\r\n: forall (Bound : list A)\r\n         (idx : BoundedIndex (map projAC Bound))\r\n         (idx' : BoundedIndex (map projAC Bound)),\r\n    match nth_error Bound (ibound idx), nth_error Bound (ibound idx') with\r\n      | Some a, Some a' => P Bound idx idx' a a'\r\n      | _, _ => True\r\n    end\r\n    -> P Bound idx idx' (nth_Bounded _ idx) (nth_Bounded _ idx'):=\r\n  fun Bound idx idx' =>\r\n    match (nth_error Bound (ibound idx)) as e, (nth_error Bound (ibound idx')) as e'\r\n          return\r\n          (forall (f : option_map _ e = Some (bindex idx))\r\n                  (f' : option_map _ e' = Some (bindex idx')),\r\n             (match e, e' with\r\n                | Some a, Some a' => P Bound idx idx' a a'\r\n                | _, _ => True\r\n              end)\r\n             -> P Bound idx idx'\r\n                  (match e as e'' return\r\n                         option_map _ e'' = Some (bindex idx)\r\n                         -> A\r\n                   with\r\n                     | Some a => fun _ => a\r\n                     | _ => fun f => _\r\n                   end f)\r\n                  (match e' as e'' return\r\n                         option_map _ e'' = Some (bindex idx')\r\n                         -> A\r\n                   with\r\n                     | Some a => fun _ => a\r\n                     | _ => fun f => _\r\n                   end f')) with\r\n      | Some a, Some a' => fun _ _ H => _\r\n      | _, _ => fun f => _\r\n    end (nth_error_map _ _ (boundi idx))\r\n        (nth_error_map _ _ (boundi idx')).\r\n\r\nLemma nth_Bounded_eq\r\n: forall (Bound : list A)\r\n         (idx idx' : BoundedIndex (map projAC Bound)),\r\n    ibound idx = ibound idx'\r\n    -> nth_Bounded Bound idx = nth_Bounded Bound idx'.\r\nProof.\r\n  intros.\r\n  eapply nth_Bounded_ind2 with (idx := idx) (idx' := idx').\r\n  simpl.\r\n  case_eq (nth_error Bound (ibound idx')).\r\n(* Toplevel input, characters 15-54:\r\nIn nested Ltac calls to \"case_eq\" and \"pattern x at - 1\", last call failed.\r\nError: The abstracted term\r\n\"fun e : Exc A =>\r\n forall e0 : nth_error Bound (ibound idx') = e,\r\n match\r\n   nth_error Bound (ibound idx) as anonymous'0\r\n   return (anonymous'0 = nth_error Bound (ibound idx) -> e = e -> Prop)\r\n with\r\n | Some a =>\r\n     match\r\n       e as anonymous'\r\n       return\r\n         (Some a = nth_error Bound (ibound idx) -> anonymous' = e -> Prop)\r\n     with\r\n     | Some a' =>\r\n         fun (_ : Some a = nth_error Bound (ibound idx)) (_ : Some a' = e) =>\r\n         a = a'\r\n     | None =>\r\n         fun (_ : Some a = nth_error Bound (ibound idx)) (_ : None = e) =>\r\n         True\r\n     end\r\n | None => fun (_ : None = nth_error Bound (ibound idx)) (_ : e = e) => True\r\n end eq_refl e0\" is not well typed.\r\nIllegal application:\r\nThe term\r\n \"match\r\n    nth_error Bound (ibound idx) as anonymous'0\r\n    return (anonymous'0 = nth_error Bound (ibound idx) -> e = e -> Prop)\r\n  with\r\n  | Some a =>\r\n      match\r\n        e as anonymous'\r\n        return\r\n          (Some a = nth_error Bound (ibound idx) -> anonymous' = e -> Prop)\r\n      with\r\n      | Some a' =>\r\n          fun (_ : Some a = nth_error Bound (ibound idx)) (_ : Some a' = e) =>\r\n          a = a'\r\n      | None =>\r\n          fun (_ : Some a = nth_error Bound (ibound idx)) (_ : None = e) =>\r\n          True\r\n      end\r\n  | None => fun (_ : None = nth_error Bound (ibound idx)) (_ : e = e) => True\r\n  end\" of type\r\n \"nth_error Bound (ibound idx) = nth_error Bound (ibound idx) ->\r\n  e = e -> Prop\"\r\ncannot be applied to the terms\r\n \"eq_refl\" : \"nth_error Bound (ibound idx) = nth_error Bound (ibound idx)\"\r\n \"e0\" : \"nth_error Bound (ibound idx') = e\"\r\nThe 2nd term has type \"nth_error Bound (ibound idx') = e\"\r\nwhich should be coercible to \"e = e\". *)\r\n```\r\nThe issue seems to have something to do with [Exc] sneaking in to some definition at some point; [unfold Exc] makes the [case_eq] go through in trunk.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519733/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519734","html_url":"https://github.com/coq/coq/issues/3345#issuecomment-337519734","issue_url":"https://api.github.com/repos/coq/coq/issues/3345","id":337519734,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzUxOTczNA==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2014-06-10T21:11:00Z","updated_at":"2017-10-18T09:18:54Z","author_association":"CONTRIBUTOR","body":"Comment author: @JasonGross\n\nNote that [Fail] does not catch this error!\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519734/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519736","html_url":"https://github.com/coq/coq/issues/3345#issuecomment-337519736","issue_url":"https://api.github.com/repos/coq/coq/issues/3345","id":337519736,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzUxOTczNg==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2015-02-27T00:22:34Z","updated_at":"2017-10-18T09:18:54Z","author_association":"CONTRIBUTOR","body":"Comment author: @maximedenes\n\nIndeed, there is something very wrong in the way this error is handled. Arnaud, can you have a look at least at that part of the bug?\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519736/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519738","html_url":"https://github.com/coq/coq/issues/3345#issuecomment-337519738","issue_url":"https://api.github.com/repos/coq/coq/issues/3345","id":337519738,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzUxOTczOA==","user":{"login":"coqbot","id":13040781,"node_id":"MDQ6VXNlcjEzMDQwNzgx","avatar_url":"https://avatars.githubusercontent.com/u/13040781?v=4","gravatar_id":"","url":"https://api.github.com/users/coqbot","html_url":"https://github.com/coqbot","followers_url":"https://api.github.com/users/coqbot/followers","following_url":"https://api.github.com/users/coqbot/following{/other_user}","gists_url":"https://api.github.com/users/coqbot/gists{/gist_id}","starred_url":"https://api.github.com/users/coqbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coqbot/subscriptions","organizations_url":"https://api.github.com/users/coqbot/orgs","repos_url":"https://api.github.com/users/coqbot/repos","events_url":"https://api.github.com/users/coqbot/events{/privacy}","received_events_url":"https://api.github.com/users/coqbot/received_events","type":"User","site_admin":false},"created_at":"2015-06-16T09:52:12Z","updated_at":"2017-10-18T09:18:54Z","author_association":"CONTRIBUTOR","body":"Comment author: @aspiwack\n\nI've got nothing on this. Currently [Fail] catches the error though.\n\n","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/337519738/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]