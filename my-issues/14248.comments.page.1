[{"url":"https://api.github.com/repos/coq/coq/issues/comments/832124479","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832124479","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832124479,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjEyNDQ3OQ==","user":{"login":"JasonGross","id":396076,"node_id":"MDQ6VXNlcjM5NjA3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/396076?v=4","gravatar_id":"","url":"https://api.github.com/users/JasonGross","html_url":"https://github.com/JasonGross","followers_url":"https://api.github.com/users/JasonGross/followers","following_url":"https://api.github.com/users/JasonGross/following{/other_user}","gists_url":"https://api.github.com/users/JasonGross/gists{/gist_id}","starred_url":"https://api.github.com/users/JasonGross/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JasonGross/subscriptions","organizations_url":"https://api.github.com/users/JasonGross/orgs","repos_url":"https://api.github.com/users/JasonGross/repos","events_url":"https://api.github.com/users/JasonGross/events{/privacy}","received_events_url":"https://api.github.com/users/JasonGross/received_events","type":"User","site_admin":false},"created_at":"2021-05-04T17:44:55Z","updated_at":"2021-05-04T17:44:55Z","author_association":"MEMBER","body":"I guess the fix for this is to change `MANDIR` at\r\nhttps://github.com/coq/coq/blob/51bc092b19f85934e4c37046fe75a36d81da4293/Makefile.install#L66-L68\r\nto something including the prefix that is set at\r\nhttps://github.com/coq/coq/blob/51bc092b19f85934e4c37046fe75a36d81da4293/Makefile.install#L45-L54 as it used to be before the dune PR in\r\nhttps://github.com/coq/coq/blob/ab98d847d237af3cd0e46edef42218be65cfc98f/Makefile.install#L40-L56","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832124479/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832126537","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832126537","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832126537,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjEyNjUzNw==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-04T17:48:18Z","updated_at":"2021-05-04T17:48:18Z","author_association":"MEMBER","body":"Actually if the only user of this machinery are the Debian packages, I'd just remove it altogether from the makefiles as dune is already configured there to install things in the right place.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832126537/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832235864","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832235864","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832235864,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjIzNTg2NA==","user":{"login":"JasonGross","id":396076,"node_id":"MDQ6VXNlcjM5NjA3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/396076?v=4","gravatar_id":"","url":"https://api.github.com/users/JasonGross","html_url":"https://github.com/JasonGross","followers_url":"https://api.github.com/users/JasonGross/followers","following_url":"https://api.github.com/users/JasonGross/following{/other_user}","gists_url":"https://api.github.com/users/JasonGross/gists{/gist_id}","starred_url":"https://api.github.com/users/JasonGross/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JasonGross/subscriptions","organizations_url":"https://api.github.com/users/JasonGross/orgs","repos_url":"https://api.github.com/users/JasonGross/repos","events_url":"https://api.github.com/users/JasonGross/events{/privacy}","received_events_url":"https://api.github.com/users/JasonGross/received_events","type":"User","site_admin":false},"created_at":"2021-05-04T20:49:27Z","updated_at":"2021-05-04T20:49:27Z","author_association":"MEMBER","body":"What do you mean by \"configured to install things in the right place\"?  I guess I also have the question: is Coq fully relocatable, or does some of the build need to know the final prefix under which it will get installed?  Because we need to install it to a different prefix than the one that will be used on the user's system.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832235864/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832245131","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832245131","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832245131,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjI0NTEzMQ==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-04T21:01:06Z","updated_at":"2021-05-04T21:01:06Z","author_association":"MEMBER","body":"> What do you mean by \"configured to install things in the right place\"?\r\n\r\nI mean that for OCaml packages, `dune install` does the right thing regarding filesystem locations, if not, that is a bug in dune. There is not need to duplicate that logic in each OCaml package, that's the job of the build system.\r\n\r\nI removed all that stuff because it was pretty horrible honestly, and mostly unused, but we can add it back; but my preference is to try to converge towards standard OCaml packaging conventions.\r\n\r\n> is Coq fully relocatable, or does some of the build need to know the final prefix under which it will get installed?\r\n\r\nThat's a tricky question for OCaml packages, but if your package uses Dune usually you don't have to care about that.\r\n\r\nThe concrete answer is that Coq is relocatable enough as to indeed build in place and still be installed in another; #14059 will make this more formal for the coq-side part.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832245131/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832696690","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832696690","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832696690,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjY5NjY5MA==","user":{"login":"JasonGross","id":396076,"node_id":"MDQ6VXNlcjM5NjA3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/396076?v=4","gravatar_id":"","url":"https://api.github.com/users/JasonGross","html_url":"https://github.com/JasonGross","followers_url":"https://api.github.com/users/JasonGross/followers","following_url":"https://api.github.com/users/JasonGross/following{/other_user}","gists_url":"https://api.github.com/users/JasonGross/gists{/gist_id}","starred_url":"https://api.github.com/users/JasonGross/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JasonGross/subscriptions","organizations_url":"https://api.github.com/users/JasonGross/orgs","repos_url":"https://api.github.com/users/JasonGross/repos","events_url":"https://api.github.com/users/JasonGross/events{/privacy}","received_events_url":"https://api.github.com/users/JasonGross/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T13:41:02Z","updated_at":"2021-05-05T13:41:02Z","author_association":"MEMBER","body":"> I mean that for OCaml packages, `dune install` does the right thing regarding filesystem locations, if not, that is a bug in dune. There is not need to duplicate that logic in each OCaml package, that's the job of the build system.\r\n> [...]\r\n> That's a tricky question for OCaml packages, but if your package uses Dune usually you don't have to care about that.\r\n\r\nI'm not sure I've communicated clearly.  When building packages on launchpad, the files are installed to `/<<BUILDDIR>>/<<PACKAGENAME>>/debian/tmp/`.  The packaging recipe then bundles them up from there, and on the user's system they get installed in `/`.  Quoting [the Ubuntu packaging guide](https://packaging.ubuntu.com/html/debian-dir-overview.html#the-install-file):\r\n> When a source package is producing multiple binary packages `dh` will install the files into `debian/tmp` rather than directly into `debian/<package>`. Files installed into `debian/tmp` can then be moved into separate binary packages using multiple `$package_name.install` files.\r\n\r\nIn particular, I think it's an antipattern to install files under `/` when building a package, because then it's hard to catch cases where the package build succeeded on your system just because you had the relevant file present globally.  (I think I've seen at least one package that I was unable to backport because it was looking for files under `/` rather than locally.)\r\n\r\nSo I need to somehow tell `dune install` to install to this location while also telling it that the ultimate install location is elsewhere.\r\n\r\nAlternatively, I suppose, if `dune` is capable of generating these install files (and in particular separate ones for [coq](https://packages.ubuntu.com/focal/amd64/coq/filelist) (the binaries and manpages and template files like CoqMakefile.in and coqdoc.css), [coq-theories](https://packages.ubuntu.com/focal/amd64/coq-theories/filelist) (standard library, plugins, stdlib doc), [libcoq-ocaml](https://packages.ubuntu.com/focal/amd64/libcoq-ocaml/filelist) (runtime libraries for Coq, which seems to be the .cmo and .cmxs files for plugins, as well as dllcoqrun.so), [coq-doc-html](https://packages.ubuntu.com/focal/all/coq-doc-html/filelist) (the refman HTML), [coq-doc-pdf](https://packages.ubuntu.com/focal/all/coq-doc-pdf/filelist) (refman pdf), [coqide](https://packages.ubuntu.com/focal/amd64/coqide/filelist) (coqide binary and associated .lang and .png files) and [libcoq-ocaml-dev](https://packages.ubuntu.com/focal/amd64/libcoq-ocaml-dev/filelist) (development libraries and tools for Coq, all the .cmi and .cmx files for Coq sources)), then I could just use those without installing the files.\r\n\r\nOtherwise, @ejgallego, how would you suggest I replace the current build-script in a way that generates the same files in the same locations?  (Current [log here](https://launchpadlibrarian.net/537038061/buildlog_ubuntu-hirsute-amd64.coq_8.master~git~202105041445+22272-0~daily347-6d08729ab5~ubuntu21.04.1_BUILDING.txt.gz))  Currently I'm running roughly:\r\n```\r\n./configure -arch Linux -prefix /usr -mandir /usr/share/man -configdir /etc/xdg/coq -browser \"/usr/bin/x-www-browser %s &\" -with-doc no\r\nmake world STRIP=true\r\nmake byte STRIP=true\r\nmake doc-stdlib-html HTMLSTYLE=simple\r\nCAML_LD_LIBRARY_PATH=$(shell pwd)/kernel/byterun COQLIB=$(shell pwd) make test-suite COMPLEXITY= PRINT_LOGS=1\r\nmake install install-byte COQINSTALLPREFIX=$(CURDIR)/debian/tmp OLDROOT= \r\n```\r\n\r\ncc also @glondu who I believe maintains the official Coq package for Ubuntu and @smimram who I believe wrote the original recipe, according to git history, and @bbarenblat who I believe also maintains the debian/ubuntu Coq packages.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832696690/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832701511","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832701511","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832701511,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjcwMTUxMQ==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T13:47:31Z","updated_at":"2021-05-05T13:47:31Z","author_association":"MEMBER","body":"Hi @JasonGross , thanks for detailed writeup, I'm familiar with Debian packaging; `dune install` uses --destdir for that case.\r\n\r\nSo what I mean, if you are using debian's dune, most options related to install location are not needed, just `--destdir` to your temporal build dir, indeed there should be something such as `dh_dune` that should fully automate the build at some point.\r\n\r\nAssuming a pure dune package, you just do:\r\n```\r\n$ dune build -p pkg1,pkg2,...\r\n$ dune install --destdir=debian/tmp pkg1 pkg2 \r\n```\r\nSo my question is, can we just have makefiles understand `DESTDIR` which seems standard?","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832701511/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832702910","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832702910","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832702910,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjcwMjkxMA==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T13:49:23Z","updated_at":"2021-05-05T13:49:23Z","author_association":"MEMBER","body":"For 8.14 + Dune 2.9, we can indeed have a fully built Coq using dune, so all the install files you mention should be generated, and I would expect Debian packaging to be something as simple as `dh_dune pkg1 pkg2 CONF=\"-native ....\"`","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832702910/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832703840","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832703840","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832703840,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjcwMzg0MA==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T13:50:36Z","updated_at":"2021-05-05T13:50:47Z","author_association":"MEMBER","body":"How to make the transition best is a bit open tho, we can bring the old variables back, or support `DESTDIR` for `make install` instead; let me know your preference.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832703840/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832707177","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832707177","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832707177,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjcwNzE3Nw==","user":{"login":"JasonGross","id":396076,"node_id":"MDQ6VXNlcjM5NjA3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/396076?v=4","gravatar_id":"","url":"https://api.github.com/users/JasonGross","html_url":"https://github.com/JasonGross","followers_url":"https://api.github.com/users/JasonGross/followers","following_url":"https://api.github.com/users/JasonGross/following{/other_user}","gists_url":"https://api.github.com/users/JasonGross/gists{/gist_id}","starred_url":"https://api.github.com/users/JasonGross/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JasonGross/subscriptions","organizations_url":"https://api.github.com/users/JasonGross/orgs","repos_url":"https://api.github.com/users/JasonGross/repos","events_url":"https://api.github.com/users/JasonGross/events{/privacy}","received_events_url":"https://api.github.com/users/JasonGross/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T13:54:53Z","updated_at":"2021-05-05T13:54:53Z","author_association":"MEMBER","body":"The [current rules file from the newly released impish for Coq 8.12](http://archive.ubuntu.com/ubuntu/pool/universe/c/coq/coq_8.12.0-3build3.debian.tar.xz) is:\r\n```makefile\r\n#!/usr/bin/make -f\r\n# debian/rules for coq\r\n\r\n# Uncomment this to turn on verbose mode.\r\n#export DH_VERBOSE=1\r\n\r\n# Build cache (for accelerating Debian debugging)\r\nBUILDCACHE := $(wildcard ../coq.cache)\r\n\r\n# This has to be exported to make some magic below work.\r\nexport CAML_LD_LIBRARY_PATH = $(shell pwd)/kernel/byterun\r\n\r\n# Show full commands when building Coq\r\nexport VERBOSE=1\r\n\r\ninclude /usr/share/ocaml/ocamlvars.mk\r\n\r\nHTMLDOC := doc/stdlib/html/index.html\r\n\r\nCOQPREF := $(CURDIR)/debian/tmp\r\nADDPREF := COQINSTALLPREFIX=$(COQPREF) OLDROOT=\r\n\r\nPACKAGES := $(shell dh_listpackages)\r\n\r\nCOQ_VERSION := 8.12.0\r\nCOQ_ABI := $(COQ_VERSION)+$(OCAML_ABI)\r\n\r\nARCH := $(shell dpkg-architecture -q DEB_TARGET_ARCH)\r\nifeq ($(ARCH),$(filter $(ARCH),amd64 i386))\r\nNATIVE_COMPUTE :=\r\nelse\r\nNATIVE_COMPUTE := -native-compiler no\r\nendif\r\nifeq ($(ARCH),s390x)\r\nBUILD_VM := -bytecode-compiler no\r\nelse\r\nBUILD_VM :=\r\nendif\r\n\r\nCONFIGUREOPTS := -arch Linux -prefix /usr -mandir /usr/share/man \\\r\n  -configdir /etc/xdg/coq \\\r\n  -browser \"/usr/bin/x-www-browser %s &\" \\\r\n  -with-doc no \\\r\n  $(NATIVE_COMPUTE) \\\r\n  $(BUILD_VM)\r\n\r\nexport OCAMLINIT_SED += \\\r\n  -e 's%@CoqVersion@%$(COQ_VERSION)%' \\\r\n  -e 's%@CoqABI@%$(COQ_ABI)%'\r\n\r\n%:\r\n\t+dh $@ --with ocaml,python3\r\n\r\n# There is already a file named \"build\" in upstream sources, so the\r\n# above rule is never called. We make it explicitly a phony rule here.\r\n.PHONY: build\r\nbuild:\r\n\t+dh $@ --with ocaml,python3\r\n\r\n.PHONY: override_dh_auto_configure\r\noverride_dh_auto_configure:\r\n\t./configure $(CONFIGUREOPTS)\r\n\r\n.PHONY: override_dh_auto_build\r\noverride_dh_auto_build:\r\nifeq ($(BUILDCACHE),)\r\n\r\n# VALIDOPTS are the options given to coqchk; the value given here is\r\n# the default one without -silent (-silent maybe cause buildd to\r\n# timeout because of lack of output)\r\n\r\n# Don't combine `make world` and `make byte`--doing so triggers a race\r\n# in the build system. See upstream's CHANGES.\r\n\t$(MAKE) world STRIP=true\r\n\t$(MAKE) byte STRIP=true\r\n\t$(MAKE) DOC_TARGETS=$(HTMLDOC) $(HTMLDOC) HTMLSTYLE=simple\r\nelse\r\n\trsync -a --exclude=debian --exclude=.git $(BUILDCACHE)/ .\r\nendif\r\n# Check that $(COQ_VERSION) has the right value\r\n\tACTUAL_COQ_VERSION=\"$$(./bin/coqc --version | awk '/version/{print $$6}')\"; \\\r\n\tif [ \"$$ACTUAL_COQ_VERSION\" != \"$(COQ_VERSION)\" ]; then \\\r\n\t  echo \"Please set COQ_VERSION to $$ACTUAL_COQ_VERSION in debian/rules\"; \\\r\n\t  exit 2; \\\r\n\tfi\r\n\r\n.PHONY: override_dh_auto_test\r\noverride_dh_auto_test:\r\nifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))\r\n\tCAML_LD_LIBRARY_PATH=$(shell pwd)/kernel/byterun COQLIB=$(shell pwd) \\\r\n\t  $(MAKE) test-suite COMPLEXITY= PRINT_LOGS=1\r\nendif\r\n\r\n.PHONY: override_dh_auto_install\r\noverride_dh_auto_install:\r\n\t$(MAKE) $(ADDPREF) install install-byte\r\n\tcp debian/coq.xpm debian/coqide/usr/share/pixmaps/coqide.xpm\r\n\tfind debian/tmp -regextype posix-awk \\\r\n\t  -regex '.*\\.(cmi|cmx|cmxa|[ao])$$' \\\r\n\t  | grep -v coq-native \\\r\n\t  >> debian/libcoq-ocaml-dev.install\r\n\tfind debian/tmp -regextype posix-awk \\\r\n\t  -regex '.*\\.(v|vo|vos|glob)$$' \\\r\n\t  >> debian/coq-theories.install\r\n\tfind debian/tmp -name '.coq-native' -printf '%P\\n' \\\r\n\t  >> debian/coq-theories.install\r\n\r\n.PHONY: override_dh_install\r\noverride_dh_install:\r\n\tchmod +x debian/coq.install\r\n\tdh_install\r\n\r\n.PHONY: override_dh_fixperms\r\noverride_dh_fixperms:\r\n\tdh_fixperms\r\n\tchmod -x debian/tmp/usr/lib/coq/tools/TimeFileMaker.py\r\n\r\n.PHONY: override_dh_ocaml\r\noverride_dh_ocaml:\r\n\tdh_ocaml\r\n\tfor f in debian/*substvars; do echo $$f; cat $$f; done\r\n\r\n.PHONY: override_dh_gencontrol\r\noverride_dh_gencontrol:\r\n\tfor u in $(PACKAGES); do \\\r\n\t  echo 'F:OCamlABI=$(OCAML_ABI)' >> debian/$$u.substvars; \\\r\n\t  echo 'F:CoqABI=$(COQ_ABI)' >> debian/$$u.substvars; \\\r\n\tdone\r\n\tdh_gencontrol\r\n```\r\n(Note that in my version of this file I've replaced the `HTMLDOC` stuff with the new `doc-stdlib-html` target.)\r\n\r\nMost of my debian packaging is cargo-culting, so I don't know what's available, don't know what to modify to switch to dune, and don't know what's preferred.  I'm happy to switch entirely to dune (though I think I'd rather defer to @bbarenblat / @glondu / the official maintainers, so as to keep my backports packaging more in sync with the official packages), but in the meantime I think it would be best to bring back the old variables so that I can test, e.g., fiat-crypto against Coq master again on CI.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832707177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832715858","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832715858","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832715858,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjcxNTg1OA==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T14:05:31Z","updated_at":"2021-05-05T14:05:31Z","author_association":"MEMBER","body":"I see, I think that can be simplified quite a bit; I'd suggest we just use `DESTDIR` as it is done in coq_makefile, IMHO seems cleaner than the oldroot newroot hack. WDYT?\r\n\r\nNote that in this case https://manpages.debian.org/jessie/debhelper/dh_auto_install.1.en.html will just use DESTDIR so things should work out-of-the-box.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832715858/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832757045","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832757045","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832757045,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjc1NzA0NQ==","user":{"login":"JasonGross","id":396076,"node_id":"MDQ6VXNlcjM5NjA3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/396076?v=4","gravatar_id":"","url":"https://api.github.com/users/JasonGross","html_url":"https://github.com/JasonGross","followers_url":"https://api.github.com/users/JasonGross/followers","following_url":"https://api.github.com/users/JasonGross/following{/other_user}","gists_url":"https://api.github.com/users/JasonGross/gists{/gist_id}","starred_url":"https://api.github.com/users/JasonGross/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JasonGross/subscriptions","organizations_url":"https://api.github.com/users/JasonGross/orgs","repos_url":"https://api.github.com/users/JasonGross/repos","events_url":"https://api.github.com/users/JasonGross/events{/privacy}","received_events_url":"https://api.github.com/users/JasonGross/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T14:57:01Z","updated_at":"2021-05-05T14:57:01Z","author_association":"MEMBER","body":"@ejgallego Sure, if `DESTDIR` serves this purpose and does not change any paths baked into the compiled files, that sounds good.  It seems that `DESTDIR` is not currently used in Coq's build system; do I need to wait for some PR to be merged to make use of it?","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832757045/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832821670","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832821670","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832821670,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjgyMTY3MA==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T16:12:25Z","updated_at":"2021-05-05T16:12:25Z","author_association":"MEMBER","body":"> @ejgallego Sure, if `DESTDIR` serves this purpose and does not change any paths baked into the compiled files, that sounds good. It seems that `DESTDIR` is not currently used in Coq's build system; do I need to wait for some PR to be merged to make use of it?\r\n\r\nYup, we need to add `DESTDIR`, let me do a PR for it; this will be actually useful as for example if we manage to finish #13890 , coq_makefile does use DESTDIR so that's one discrepancy we get rid of now.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832821670/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832987802","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832987802","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832987802,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjk4NzgwMg==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T20:32:30Z","updated_at":"2021-05-05T20:32:57Z","author_association":"MEMBER","body":"Ok, using #14258 you should be able to replace this line:\r\n```\r\n$(MAKE) $(ADDPREF) install install-byte\r\n```\r\nwith\r\n```\r\n$(MAKE) DESTDIR=$(CURDIR)/debian/tmp install\r\n```","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832987802/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/coq/coq/issues/comments/832988316","html_url":"https://github.com/coq/coq/issues/14248#issuecomment-832988316","issue_url":"https://api.github.com/repos/coq/coq/issues/14248","id":832988316,"node_id":"MDEyOklzc3VlQ29tbWVudDgzMjk4ODMxNg==","user":{"login":"ejgallego","id":7192257,"node_id":"MDQ6VXNlcjcxOTIyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/7192257?v=4","gravatar_id":"","url":"https://api.github.com/users/ejgallego","html_url":"https://github.com/ejgallego","followers_url":"https://api.github.com/users/ejgallego/followers","following_url":"https://api.github.com/users/ejgallego/following{/other_user}","gists_url":"https://api.github.com/users/ejgallego/gists{/gist_id}","starred_url":"https://api.github.com/users/ejgallego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ejgallego/subscriptions","organizations_url":"https://api.github.com/users/ejgallego/orgs","repos_url":"https://api.github.com/users/ejgallego/repos","events_url":"https://api.github.com/users/ejgallego/events{/privacy}","received_events_url":"https://api.github.com/users/ejgallego/received_events","type":"User","site_admin":false},"created_at":"2021-05-05T20:33:25Z","updated_at":"2021-05-05T20:33:25Z","author_association":"MEMBER","body":"or even maybe just `DESTDIR=$(DESTDIR)` [not sure the override for dh_auto_install sets it.","reactions":{"url":"https://api.github.com/repos/coq/coq/issues/comments/832988316/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]